<!DOCTYPE html>
<html lang="en">
<head>
    <div th:replace="~{fragments/headApp :: head}"></div>
    <script type="text/javascript" th:src="@{/js/main.js}"></script>
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
</head>
<body>
<div th:replace="~{fragments/navbarApp :: navigation}"></div>

<div class="container-fluid">
    <div class="row hello">
        <div class="col-12 col-md-12">
            <div class="text">
                <br/><br/><br/>
                <h4>Opcje grupy</h4>
            </div>
            <hr/>

            <div class="container-fluid">
                <div class="col-lg-6">
                    <button
                            class="navigation-card-button"
                            onclick="changePanel('group-table')"
                            type="submit"
                    >
                        Lista grup
                    </button>
                    <button
                            class="navigation-card-button"
                            onclick="changePanel('group-add')"
                            type="submit"
                    >
                        Dodawanie grup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<section id="group-table">
    <div id="alert-price-fail-group" style="display: none" class="alert alert-danger alert-dismissible fade show"
         role="alert">

    </div>
    <div id="alert-price-success-group" style="display: none" class="alert alert-success alert-dismissible fade show"
         role="alert">
    </div>

    <div class="container-fluid text-center">
        <div class="row" style="padding: 10px">
            <div class="col-lg-12 right-panel container-custom">
                <table class="table">
                    <thead>
                    <tr>
                        <th class="colth" scope="col"></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Nazwa</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Terminy</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Ceny</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Lokalizacja</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Prowadzący</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Miejsca</span></th>
                        <th class="colth" scope="col">
                            <span style="font-size: 0.9em!important">Informacje</span>
                        </th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Data od</span></th>
                        <th class="colth" scope="col"><span style="font-size: 0.9em!important">Data do</span></th>
                        <th class="colth" scope="col">
                            <span style="font-size: 0.9em!important">Kolor</span>
                        </th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody id="tbody-element-group">

                    </tbody>

                </table>
            </div>
        </div>
    </div>
</section>
<section id="group-add" style="display: none">
    <div class="container text-center">
        <div class="row" style="">
            <div class="col-lg-6 right-panel">
                <form class="login-form" th:action="@{/app/postGroup}" method="POST">
                    <input
                            hidden
                            class="form-control "
                            type="text"
                            id="group-id"
                            name="groupId"

                    />
                    <input
                            class="form-control my-3"
                            type="text"
                            id="group-name"
                            name="groupName"
                            placeholder="Nazwa grupy *"
                    />
                    <ul
                            style="font-size: 0.7em"
                            class="list-group list-unstyled list-group-flush"
                            th:if="${prices.empty}"
                    >
                        <li class="">
                            <b> Brak cen </b>
                        </li>
                    </ul>
                    <ul style="font-size: 0.7em"
                        class="list-group list-unstyled list-group-flush"
                        th:if="${!prices.empty}">
                        <li class="my-2">
                            <input style="width: 20px !important;" type="checkbox" id="input-prices"
                                   onclick="showOrHide('input-prices','prices-ul')">
                            <b>Wyświetl dostępne ceny</b>
                            </hr>
                        </li>
                    </ul>

                    <div style="display:none;float: left;" class="my-2" id="prices-ul">
                        <ul
                                style="font-size: 0.6em; float: left;"
                                class="list-group list-unstyled list-group-flush"
                                th:each="prices : ${prices}">
                            <li class="">
                                <input type="checkbox" id="scales" name="${prices.idPrice}" th:name="priceIds"
                                       th:value="${prices.idPrice}"/>
                                <input style="display: none" type="text"/> <span style="display: none"
                                                                                 th:text="${prices.idPrice}"></span>
                                <b> Cena: </b> <span th:text="${prices.value} + zł"> </span>&nbsp;&nbsp;
                                <b> Nazwa: </b> <span th:text="${prices.name}"> </span>&nbsp;&nbsp;
                                <b> Cykl rozliczeniowy: </b><span th:text="${prices.cycle}"> </span>&nbsp;&nbsp;
                                <b> Opis: </b><span th:text="${prices.description}"></span>
                            </li>
                        </ul>
                    </div>
                    <div id="group-information">
                        <input
                                class="form-control my-2"
                                type="text"
                                id="group-location"
                                name="groupPlace"
                                placeholder="Miejsce"
                        />
                        <input
                                class="form-control my-2"
                                type="number"
                                id="group-size"
                                name="groupSize"
                                placeholder="Wielkość grupy"
                        />
                        <input
                                id="group-leader-name"
                                class="form-control mr-sm-2 my-2"
                                type="search"
                                name="groupLeader"
                                placeholder="Imie oraz nazwisko prowdzącego"
                                aria-label="Search"
                        />

                        <select id="group-color" name="groupColor" class="form-control mr-sm-2 my-2 w-100">
                            <option value="ffffff">Bez koloru</option>
                            <option style="background-color: #6b5b95;" value="6b5b95">#6b5b95</option>
                            <option style="background-color: #ff7b25;" value="ff7b25">#ff7b25</option>
                            <option style="background-color: #feb236;" value="feb236">#feb236</option>
                            <option style="background-color: #86af49;" value="86af49">#86af49</option>
                            <option style="background-color: #d64161;" value="d64161">#d64161</option>
                            <option style="background-color: #3e4444;" value="3e4444">#3e4444</option>
                            <option style="background-color: #c1946a;" value="c1946a">#c1946a</option>
                            <option style="background-color: #034f84;" value="034f84">#034f84</option>
                            <option style="background-color: #50394c;" value="50394c">#50394c</option>
                            <option style="background-color: #4040a1;" value="4040a1">#4040a1</option>
                            <option style="background-color: #034f84;" value="034f84">#034f84</option>
                            <option style="background-color: #e3eaa7;" value="e3eaa7">#e3eaa7</option>
                            <option style="background-color: #f4e1d2;" value="f4e1d2">#f4e1d2</option>
                        </select>

                        <span style="font-size: 0.7em"> Daty od i do:</span>
                        <input
                                class="form-control my-2"
                                type="date"
                                id="group-data-of-start"
                                name="groupDataFrom"
                                placeholder="Data rozpoczęcia"
                        />

                        <input
                                class="form-control my-2"
                                type="date"
                                id="group-data-of-end"
                                name="groupDataTo"
                                placeholder="Data zakończenia"
                        />
                    </div>
                    <textarea
                            class="form-control mr-sm-2 my-2"
                            type="textarea"
                            id="group-description"
                            name="groupDescription"
                            placeholder="informacja dodatkowa"
                    ></textarea>
                    <div id="term">
                        <div id="part-term" style="display: flex"></div>
                    </div>
                    <a class="btn btn-outline-edit w-100 my-3" onclick="addTerm()">Dodaj termin</a>
                    <input id="group-first-free" style="width: 20px !important;" name="groupFirstFree" type="checkbox">
                    <b style="font-size: 0.7em">Pierwszy wejście za darmo</b>
                    <hr/>

                    <button id="button-edit-group" class="btn btn-outline-info w-100" type="submit">
                        Edytuj
                    </button>
                    <button id="button-save-group" class="btn btn-outline-success w-100" onclick="removeId('group-id')"
                            type="submit">
                        Zapisz
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>
<section id="modals">
</section>
<script type="text/javascript">

    window.onload = function () {
        getGroups();
    };

    function deleteGroup(element) {

            var xhr = new XMLHttpRequest();

            xhr.open('POST', "/app/deleteGroup?groupId=" + element, true);

            xhr.send('');
            var result = "";
            xhr.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    result = xhr.responseText;
                    getGroups();
                    document.getElementById('alert-price-fail-group').innerText = result;
                    document.getElementById('alert-price-success-group').innerText = result;
                } else {

                }
            }
            document.getElementById('alert-price-fail-group').style.display = "none";
            document.getElementById('alert-price-success-group').style.display = "block";
    }


    function update(element, table) {
        let splitResult = splitElement(element);

        if (table === "group") {
            var startTerms = element.outerHTML.indexOf("startTerms:") + 11;
            var stopTerms = element.outerHTML.indexOf(":stopTerms");
            let result = element.outerHTML.substring(startTerms, stopTerms);
            let splitTerms = result.split(',');
            editGroup(splitResult, splitTerms);
        }
        if (table === "price") {
        }

    }

    function splitElement(element) {
        var start = element.outerHTML.indexOf("start:") + 6;
        var stop = element.outerHTML.indexOf(":stop");
        let result = element.outerHTML.substring(start, stop);
        let splitResult = result.split(',');
        return splitResult;
    }

    function getPricesId(event) {
        let splitResult = splitElement(event);
        var xhr = new XMLHttpRequest();

        xhr.open('GET', "/app/getPricesId?groupId=" + splitResult[0], true);
        xhr.send('');
        var result = "";
        xhr.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                result = JSON.parse(xhr.responseText);
            } else {
            }
        }
    }
    function removeId(elementToRemove) {
        document.getElementById(elementToRemove).value = "";
    }


    function editGroup(idTeam,teamName,place,leaderName,groupSize,description,startDate,endDate,color,convertedTerms,checkedPriceIds,allPrices,allPriceIds) {

        console.log(idTeam);
        console.log(teamName);
        console.log(place);
        console.log(leaderName);
        console.log(groupSize);
        console.log(description);
        console.log(startDate);
        console.log(endDate);
        console.log(color);
        console.log(convertedTerms);
        console.log(checkedPriceIds);
        console.log(allPrices);
        console.log(allPriceIds);

        var modalEdit = "exampleModalGroupEdit" + idTeam;
        var modalLabelEdit = "exampleModalLabelGroupEdit" + idTeam;

        var result =

            '<Button  id="editButton" hidden  class="option-card-button" data-toggle="modal" data-target="#' + modalEdit + '" >Usuń</Button>' +
            '<div class="modal fade" id="' + modalEdit + '" tabindex="-1" role="dialog" aria-labelledby="' + modalLabelEdit + '" aria-hidden="true">\n' +
            '     <div class="modal-dialog" role="document">\n' +
            '         <div class="modal-content">\n' +
            '             <div class="modal-header">\n' +
            '                 <h5 class="modal-title" id="' + modalLabelEdit + '">Edytowanie grupy</h5>\n' +
            '                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n' +
            '                     <span aria-hidden="true">&times;</span>\n' +
            '                 </button>\n' +
            '             </div>\n' +
            '             <div id="modal-body-edit' + idTeam + '" class="modal-body">\n' +
            '                <input hidden value="' + idTeam + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Nazwa grupy</div>       <input value="' + teamName + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Lokalizacja</div>       <input value="' + place + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Prowadzący</div>        <input value="' + leaderName + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Wielkośc grupy</div>    <input value="' + groupSize + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Opis</div>              <input value="' + description + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Data od</div>           <input type="date" value="' + startDate + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> Data do</div>           <input type="date" value="' + endDate + '" class="form-control my-1 mr-sm-2" />' +
            '                <div style="font-size: 0.6em!important; font-weight: 600"> kolor</div>             <input value="' + color + '" class="form-control my-1 mr-sm-2"/>' +
            '             </div>\n' +
            '             <div class="modal-footer">\n' +
            '                 <button id="button-edit-group" class="option-card-button btnShow" data-dismiss="modal" style="font-size: 0.9em!important;  min-width: 75px!important; height: auto!important"\n' +
            '                         onclick="">Edytuj</button>\n' +
            '                 <button type="button" class="option-card-button" style="font-size: 0.9em!important; min-width: 75px!important; height: auto!important" data-dismiss="modal">Anuluj</button>\n' +
            '             </div>\n' +
            '         </div>\n' +
            '     </div>\n' +
            ' </div>';

        document.getElementById("modals").innerHTML = result;
        document.getElementById("editButton").click();


    }

    function changePanel(element) {
        var group_table = document.getElementById("group-table");
        var group_add = document.getElementById("group-add");
        if (element === "group-table") {
            group_table.style.display = "block";
            group_add.style.display = "none";
            return;
        }
        if (element === "group-add") {
            group_table.style.display = "none";
            group_add.style.display = "block";

        }
    }

    function showOrHide(element, nameId) {
        if (document.getElementById(element).checked) {
            document.getElementById(nameId).style.display = "block";
            return;
        }
        document.getElementById(nameId).style.display = "none";
    }

    function addTerm() {
        var termIncrease = document.getElementById("term").innerHTML;

        document.getElementById("term").innerHTML =
            termIncrease +
            '<div style="display: flex;">\n' +
            '<select name="groupDayFor" class="form-control mr-sm-2 my-2 w-100"  >\n' +
            '<option value="Poniedziałek" selected>Poniedziałek</option>\n' +
            '<option value="Wtorek" >Wtorek</option>\n' +
            '<option value="Środa" >Środa</option>\n' +
            '<option value="Czwartek" >Czwartek</option>\n' +
            '<option value="Piątek" >Piątek</option>\n' +
            '<option value="Sobota" >Sobota</option>\n' +
            '<option value="Niedziela" >Niedziela</option>\n' +
            '</select>\n' +
            '<select name="groupTimeFromHour" class="form-control mr-sm-2 my-2" style="width: auto!important" >\n' +
            '<option value="06" selected>06</option>\n' +
            '<option value="07" >07</option>\n' +
            '<option value="08" >08</option>\n' +
            '<option value="09" >09</option>\n' +
            '<option value="10" >10</option>\n' +
            '<option value="11" >11</option>\n' +
            '<option value="12" >12</option>\n' +
            '<option value="13" >13</option>\n' +
            '<option value="14" >14</option>\n' +
            '<option value="15" >15</option>\n' +
            '<option value="16" >16</option>\n' +
            '<option value="17" >17</option>\n' +
            '<option value="18" >18</option>\n' +
            '<option value="19" >19</option>\n' +
            '<option value="20" >20</option>\n' +
            '<option value="21" >21</option>\n' +
            '<option value="22" >22</option>\n' +
            '<option value="23" >23</option>\n' +
            '</select>\n' +
            '<select name="groupTimeFromMinute" class="form-control mr-sm-2 my-2 " style="width: auto!important" >\n' +
            '<option value="00" selected>00</option>\n' +
            '<option value="05" >05</option>\n' +
            '<option value="10" >10</option>\n' +
            '<option value="15" >15</option>\n' +
            '<option value="20" >20</option>\n' +
            '<option value="25" >25</option>\n' +
            '<option value="30" >30</option>\n' +
            '<option value="35" >35</option>\n' +
            '<option value="40" >40</option>\n' +
            '<option value="45" >45</option>\n' +
            '<option value="50" >50</option>\n' +
            '<option value="55" >55</option>\n' +
            '</select> \n ' +
            '-  <select name="groupTimeToHour" class="form-control mr-sm-2 my-2 " style="width: auto!important"  >\n' +
            '<option value="06" selected>06</option>\n' +
            '<option value="07" >07</option>\n' +
            '<option value="08" >08</option>\n' +
            '<option value="09" >09</option>\n' +
            '<option value="10" >10</option>\n' +
            '<option value="11" >11</option>\n' +
            '<option value="12" >12</option>\n' +
            '<option value="13" >13</option>\n' +
            '<option value="14" >14</option>\n' +
            '<option value="15" >15</option>\n' +
            '<option value="16" >16</option>\n' +
            '<option value="17" >17</option>\n' +
            '<option value="18" >18</option>\n' +
            '<option value="19" >19</option>\n' +
            '<option value="20" >20</option>\n' +
            '<option value="21" >21</option>\n' +
            '<option value="22" >22</option>\n' +
            '<option value="23" >23</option>\n' +
            '</select>\n' +
            '<select name="groupTimeToMinute" class="form-control mr-sm-2 my-2 " style="width: auto!important" >\n' +
            '<option value="00" selected>00</option>\n' +
            '<option value="05" >05</option>\n' +
            '<option value="10" >10</option>\n' +
            '<option value="15" >15</option>\n' +
            '<option value="20" >20</option>\n' +
            '<option value="25" >25</option>\n' +
            '<option value="30" >30</option>\n' +
            '<option value="35" >35</option>\n' +
            '<option value="40" >40</option>\n' +
            '<option value="45" >45</option>\n' +
            '<option value="50" >50</option>\n' +
            '<option value="55" >55</option>\n' +
            '</select>\n' +
            "</div>";
    }

    function getGroups() {
        var xhr = new XMLHttpRequest();

        xhr.open('GET', "/app/getGroups/", true);
        xhr.send('');

        xhr.onreadystatechange = function () {
            var groups;
            if (this.readyState === 4 && this.status === 200) {
                groups = JSON.parse(xhr.responseText);
                generateTableGroup(groups);
            }
        }
    }

    function generateTableGroup(groups){

      var result = "";

        for (let i = 0; i < groups.length; i++) {

            var createTerms="";
            for (let j = 0; j < groups[i]['terms'].length; j++)
            {
                createTerms = createTerms + groups[i]['terms'][j] + '</br>' ;
            }
            var checkedIds = "";

            var pricesInfos ="";
            var checkedPriceIds ="";
            for (let j = 0; j <  groups[i]['checkedPrices'].length; j++) {
                pricesInfos =  pricesInfos +'' +''  + groups[i]['checkedPrices'][j]['name'] +' - '+ groups[i]['checkedPrices'][j]['value']+'zł - '+ groups[i]['checkedPrices'][j]['cycle'] +'dni' +'<br>';
                checkedPriceIds = checkedPriceIds+',' +groups[i]['checkedPrices'][j]['idPrice'] ;
            }

            var allPrices = "";
            var allPriceIds = "";

            for (let j = 0; j <  groups[i]['allPrices'].length; j++) {
                allPrices =  allPrices + groups[i]['allPrices'][j]['name'] +' - '+ groups[i]['allPrices'][j]['value']+'zł - '+ groups[i]['allPrices'][j]['cycle'] +'dni ' + groups[i]['allPrices'][j]['description'] +'<br>';
                allPriceIds = allPriceIds+ ',' +groups[i]['allPrices'][j]['idPrice'];
            }

          var  convertedTerms = "'" + createTerms + "'";
          var  idTeam = "'" +  groups[i]['teams']['idTeam']  + "'";
          var  teamName = "'" + groups[i]['teams']['teamName'] + "'";
          var  place = "'" + groups[i]['teams']['place'] + "'";
          var  leaderName = "'" + groups[i]['teams']['leaderName']  + "'";
          var  groupSize = "'" + groups[i]['teams']['groupSize'] + "'";
          var  description = "'" + groups[i]['teams']['description'] + "'";
          var  startDate = "'" + groups[i]['teams']['startDate'] + "'";
          var  endDate = "'" + groups[i]['teams']['endDate']  + "'";
          var  color = "'" + groups[i]['teams']['color'] + "'";

          var checkedPriceIds = "'" + checkedPriceIds+ "'";
          var allPrices  = "'" + allPrices + "'";
          var allPriceIds  = "'" + allPriceIds + "'";

            var modal = "exampleModalGroup"+ groups[i]['teams']['idTeam'];
            var modalLabel="exampleModalLabelGroup"+ groups[i]['teams']['idTeam'];

            result = result
                +
                '<tr style="font-size: 0.9em!important"> ' +
                '<td scope="row">' +
                '<input hidden style="width: 20px !important;" type="checkbox"  th:name="groupId"  th:value="' + groups[i]['teams']['idTeam'] + '"   class="option"/>' +
                '</td>' +
                '<td >' + groups[i]['teams']['teamName'] + '</td>' +
                '<td >' + createTerms + '</td>' +
                '<td >' + pricesInfos + '</td>' +
                '<td >' + groups[i]['teams']['place'] + '</td>' +
                '<td >' + groups[i]['teams']['leaderName'] + '</td>' +
                '<td >' + groups[i]['teams']['freeSpace'] + ' / ' + groups[i]['teams']['groupSize'] + '</td>' +
                '<td >' + groups[i]['teams']['description'] + '</td>' +
                '<td >' + groups[i]['teams']['startDate'] + '</td>' +
                '<td >' + groups[i]['teams']['endDate'] + '</td>' +
                '<td >' + groups[i]['teams']['color'] + '</td>' +
                '<td data-label="info."> ' +
                '<button  class="option-card-button" onclick="editGroup('+idTeam+','+teamName+','+place+','+leaderName+','+groupSize+','+description+','+startDate+','+endDate+','+color+','+convertedTerms+','+checkedPriceIds+','+allPrices+','+allPriceIds+')">Edytuj</button>&nbsp;' +
                '<button  class="option-card-button" ' +
                'data-toggle="modal" data-target="#'+modal+'" >Usuń</button>' +
                '</td>' +
                ' <div class="modal fade"   id="'+modal+'" tabindex="-1" role="dialog" aria-labelledby="'+modalLabel+'" aria-hidden="true">\n' +
                '     <div class="modal-dialog" role="document">\n' +
                '         <div class="modal-content">\n' +
                '             <div class="modal-header">\n' +
                '                 <h5 class="modal-title" id="'+modalLabel+'">Usuwanie grupy</h5>\n' +
                '                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n' +
                '                     <span aria-hidden="true">&times;</span>\n' +
                '                 </button>\n' +
                '             </div>\n' +
                '             <div class="modal-body">\n' +
                '                 Czy napewno chcesz usunąć grupę?\n' +
                '             </div>\n' +
                '             <div class="modal-footer">\n' +
                '                 <button class="option-card-button btnShow" data-dismiss="modal" style="font-size: 0.9em!important;  min-width: 75px!important; height: auto!important"\n' +
                '                         onclick="deleteGroup(' + groups[i]['teams']['idTeam'] + ')">Tak</button>\n' +
                '                 <button type="button" class="option-card-button" style="font-size: 0.9em!important; min-width: 100px!important; height: auto!important" data-dismiss="modal">Anuluj</button>\n' +
                '             </div>\n' +
                '         </div>\n' +
                '     </div>\n' +
                ' </div>'
                '</tr>';
        }

        document.getElementById("tbody-element-group").innerHTML = result;
    }

</script>

</body>
</html>